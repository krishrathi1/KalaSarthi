<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline AI Browser Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .success {
            border-color: #4CAF50;
            background: #f8fff8;
        }

        .error {
            border-color: #f44336;
            background: #fff8f8;
        }

        .loading {
            border-color: #2196F3;
            background: #f8f8ff;
        }

        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #1976D2;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }

        .log {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .response {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ü§ñ Offline AI Browser Test</h1>
        <p>This test verifies if the offline AI model works in a browser environment.</p>

        <div id="status" class="test-section">
            <h3>üìä Status</h3>
            <p id="statusText">Ready to test</p>
            <div class="progress">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <p id="progressText">0% - Ready</p>
        </div>

        <div class="test-section">
            <h3>üß™ Tests</h3>
            <button onclick="testWebLLMAvailability()">Test WebLLM Availability</button>
            <button onclick="initializeAI()" id="initBtn">Initialize Offline AI</button>
            <button onclick="testResponses()" id="testBtn" disabled>Test AI Responses</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>

        <div class="test-section">
            <h3>üìù Test Log</h3>
            <div id="log" class="log"></div>
        </div>

        <div id="responses" class="test-section" style="display: none;">
            <h3>üí¨ AI Responses</h3>
            <div id="responseContainer"></div>
        </div>
    </div>

    <script type="module">
        let aiService = null;
        let isInitialized = false;

        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStatus(text, className = '') {
            const statusElement = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            statusText.textContent = text;
            statusElement.className = `test-section ${className}`;
        }

        function updateProgress(progress, stage) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}% - ${stage}`;
        }

        window.testWebLLMAvailability = async function () {
            log('Testing WebLLM availability...');
            try {
                const { CreateMLCEngine } = await import('https://esm.sh/@mlc-ai/web-llm');
                log('WebLLM imported successfully', 'success');
                updateStatus('WebLLM is available', 'success');
                return true;
            } catch (error) {
                log(`WebLLM import failed: ${error.message}`, 'error');
                updateStatus('WebLLM not available - will use fallback', 'error');
                return false;
            }
        };

        window.initializeAI = async function () {
            const initBtn = document.getElementById('initBtn');
            const testBtn = document.getElementById('testBtn');

            initBtn.disabled = true;
            updateStatus('Initializing AI...', 'loading');
            log('Starting AI initialization...');

            try {
                // Simulate our SimpleOfflineAI service
                aiService = {
                    isReady: false,
                    modelType: 'unknown',

                    async initialize(progressCallback) {
                        log('Attempting to load WebLLM model...');
                        progressCallback(10, 'Initializing WebLLM...');

                        try {
                            // Try WebLLM first
                            const { CreateMLCEngine } = await import('https://esm.sh/@mlc-ai/web-llm');
                            progressCallback(30, 'Loading Phi-3 Mini model...');

                            // This will likely fail due to CORS or other browser restrictions
                            const engine = await CreateMLCEngine('Phi-3-mini-4k-instruct-q4f16_1-MLC', {
                                initProgressCallback: (progress) => {
                                    const percentage = Math.round(progress.progress * 60) + 30;
                                    progressCallback(percentage, `Loading model: ${progress.text}`);
                                }
                            });

                            this.engine = engine;
                            this.modelType = 'WebLLM';
                            progressCallback(100, 'WebLLM model ready!');
                            log('WebLLM model loaded successfully!', 'success');

                        } catch (error) {
                            log(`WebLLM failed: ${error.message}`, 'error');
                            log('Falling back to rule-based system...');

                            progressCallback(70, 'Loading fallback model...');

                            // Simulate loading time for fallback
                            await new Promise(resolve => setTimeout(resolve, 1000));

                            this.modelType = 'Rule-based';
                            progressCallback(100, 'Fallback model ready!');
                            log('Fallback AI system ready', 'success');
                        }

                        this.isReady = true;
                        return true;
                    },

                    async generateResponse(message) {
                        if (!this.isReady) throw new Error('AI not initialized');

                        const startTime = performance.now();
                        let response;

                        if (this.modelType === 'WebLLM' && this.engine) {
                            // Real AI response
                            const result = await this.engine.chat.completions.create({
                                messages: [
                                    { role: 'system', content: 'You are an AI assistant specialized in helping artisans and craftspeople with their business and creative needs.' },
                                    { role: 'user', content: message }
                                ],
                                max_tokens: 150,
                                temperature: 0.7
                            });
                            response = result.choices[0]?.message?.content || 'No response generated';
                        } else {
                            // Rule-based fallback
                            const isHindi = /[\u0900-\u097F]/.test(message);
                            const msg = message.toLowerCase();

                            if (msg.includes('hello') || msg.includes('hi') || msg.includes('‡§®‡§Æ‡§∏‡•ç‡§§‡•á')) {
                                response = isHindi
                                    ? '‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ Artisan Buddy ‡§π‡•Ç‡§Å‡•§ ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§∂‡§ø‡§≤‡•ç‡§™‡§ï‡§æ‡§∞‡•Ä ‡§î‡§∞ ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å‡•§'
                                    : 'Hello! I\'m your Artisan Buddy. I can help you with crafts and business.';
                            } else if (msg.includes('business') || msg.includes('‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞')) {
                                response = isHindi
                                    ? '‡§Ü‡§™‡§ï‡•á ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Æ‡•à‡§Ç ‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü‡§ø‡§Ç‡§ó, ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§®‡§ø‡§∞‡•ç‡§ß‡§æ‡§∞‡§£, ‡§î‡§∞ ‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å‡•§'
                                    : 'I can help you with marketing, pricing, and customer management for your business.';
                            } else {
                                response = isHindi
                                    ? '‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§∂‡§ø‡§≤‡•ç‡§™‡§ï‡§æ‡§∞‡•Ä ‡§î‡§∞ ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡•Ä ‡§∏‡§≠‡•Ä ‡§ú‡§∞‡•Ç‡§∞‡§§‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ø‡§π‡§æ‡§Å ‡§π‡•Ç‡§Å‡•§'
                                    : 'I\'m here to help with all your craft and business needs.';
                            }
                        }

                        const processingTime = performance.now() - startTime;
                        return {
                            text: response,
                            confidence: this.modelType === 'WebLLM' ? 0.9 : 0.6,
                            processingTime,
                            modelType: this.modelType
                        };
                    },

                    getModelInfo() {
                        return {
                            modelId: this.modelType === 'WebLLM' ? 'Phi-3-mini-4k-instruct-q4f16_1-MLC' : 'Rule-based Fallback',
                            type: this.modelType,
                            isReady: this.isReady,
                            capabilities: ['Text Generation', 'Hindi/English', 'Artisan Context']
                        };
                    }
                };

                const success = await aiService.initialize((progress, stage) => {
                    updateProgress(progress, stage);
                });

                if (success) {
                    isInitialized = true;
                    testBtn.disabled = false;
                    updateStatus(`AI initialized successfully (${aiService.modelType})`, 'success');
                    log(`AI ready! Model type: ${aiService.modelType}`, 'success');

                    const modelInfo = aiService.getModelInfo();
                    log(`Model Info: ${JSON.stringify(modelInfo, null, 2)}`);
                } else {
                    throw new Error('AI initialization failed');
                }

            } catch (error) {
                log(`Initialization error: ${error.message}`, 'error');
                updateStatus('AI initialization failed', 'error');
            } finally {
                initBtn.disabled = false;
            }
        };

        window.testResponses = async function () {
            if (!isInitialized || !aiService) {
                log('AI not initialized yet', 'error');
                return;
            }

            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;

            const responsesDiv = document.getElementById('responses');
            const responseContainer = document.getElementById('responseContainer');
            responsesDiv.style.display = 'block';
            responseContainer.innerHTML = '';

            const testQueries = [
                'Hello, how can you help me with my craft business?',
                '‡§Æ‡•à‡§Ç ‡§è‡§ï ‡§ï‡§æ‡§∞‡•Ä‡§ó‡§∞ ‡§π‡•Ç‡§Å, ‡§Æ‡•Å‡§ù‡•á ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ö‡§æ‡§π‡§ø‡§è',
                'How should I price my handmade jewelry?',
                '‡§Æ‡•á‡§∞‡•á ‡§â‡§§‡•ç‡§™‡§æ‡§¶‡•ã‡§Ç ‡§ï‡•ã ‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§ï‡•à‡§∏‡•á ‡§¨‡•á‡§ö‡•Ç‡§Ç?'
            ];

            log('Starting response tests...');

            for (let i = 0; i < testQueries.length; i++) {
                const query = testQueries[i];
                log(`Testing query ${i + 1}: "${query}"`);

                try {
                    const response = await aiService.generateResponse(query);

                    log(`Response ${i + 1} (${Math.round(response.processingTime)}ms, confidence: ${response.confidence}, model: ${response.modelType}): "${response.text.substring(0, 100)}..."`, 'success');

                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'response';
                    responseDiv.innerHTML = `
                        <strong>Query:</strong> ${query}<br>
                        <strong>Response:</strong> ${response.text}<br>
                        <small>Model: ${response.modelType} | Time: ${Math.round(response.processingTime)}ms | Confidence: ${response.confidence}</small>
                    `;
                    responseContainer.appendChild(responseDiv);

                } catch (error) {
                    log(`Response ${i + 1} failed: ${error.message}`, 'error');
                }
            }

            log('Response tests completed!', 'success');
            testBtn.disabled = false;
        };

        window.clearLog = function () {
            document.getElementById('log').textContent = '';
            document.getElementById('responseContainer').innerHTML = '';
            document.getElementById('responses').style.display = 'none';
        };

        // Initialize on page load
        log('Browser AI test page loaded');
        log('Click "Test WebLLM Availability" to check if WebLLM can be imported');
        log('Click "Initialize Offline AI" to test the full initialization process');
    </script>
</body>

</html>