graph TD
    %% Start Point
    START([User Requests AI Image Generation]) --> AUTH_CHECK{User Authenticated?}

    %% Authentication Branch
    AUTH_CHECK -->|No| LOGIN_REDIRECT[Redirect to Login]
    AUTH_CHECK -->|Yes| SUBSCRIPTION_CHECK{Subscription Valid?}

    %% Subscription Branch
    SUBSCRIPTION_CHECK -->|No| UPGRADE_PROMPT[Show Upgrade Prompt]
    SUBSCRIPTION_CHECK -->|Yes| INPUT_METHOD{Input Method}

    %% Input Method Selection
    INPUT_METHOD -->|Text Prompt| TEXT_PROMPT_AGENT[ðŸ“ Text Prompt Agent]
    INPUT_METHOD -->|Voice Input| VOICE_PROMPT_AGENT[ðŸŽ¤ Voice Prompt Agent]
    INPUT_METHOD -->|Image Reference| REFERENCE_IMAGE_AGENT[ðŸ–¼ï¸ Reference Image Agent]
    INPUT_METHOD -->|Template| TEMPLATE_AGENT[ðŸ“‹ Template Agent]

    %% Text Prompt Flow
    TEXT_PROMPT_AGENT --> PROMPT_VALIDATION_AGENT[âœ… Prompt Validation Agent]
    PROMPT_VALIDATION_AGENT -->|Valid| PROMPT_ENHANCEMENT_AGENT[âœ¨ Prompt Enhancement Agent]
    PROMPT_VALIDATION_AGENT -->|Invalid| PROMPT_CORRECTION_AGENT[ðŸ”§ Prompt Correction Agent]

    PROMPT_CORRECTION_AGENT --> TEXT_PROMPT_AGENT

    %% Voice Prompt Flow
    VOICE_PROMPT_AGENT --> VOICE_CAPTURE_AGENT[ðŸŽ™ï¸ Voice Capture Agent]
    VOICE_CAPTURE_AGENT --> SPEECH_TO_TEXT_AGENT[ðŸ—£ï¸ Speech-to-Text Agent]
    SPEECH_TO_TEXT_AGENT --> TEXT_PROMPT_AGENT

    %% Reference Image Flow
    REFERENCE_IMAGE_AGENT --> IMAGE_UPLOAD_AGENT[ðŸ“¸ Image Upload Agent]
    IMAGE_UPLOAD_AGENT --> IMAGE_ANALYSIS_AGENT[ðŸ” Image Analysis Agent]
    IMAGE_ANALYSIS_AGENT --> PROMPT_GENERATION_AGENT[ðŸ¤– Prompt Generation Agent]
    PROMPT_GENERATION_AGENT --> TEXT_PROMPT_AGENT

    %% Template Flow
    TEMPLATE_AGENT --> TEMPLATE_SELECTION_AGENT[ðŸ“‹ Template Selection Agent]
    TEMPLATE_SELECTION_AGENT --> TEMPLATE_CUSTOMIZATION_AGENT[ðŸŽ¨ Template Customization Agent]
    TEMPLATE_CUSTOMIZATION_AGENT --> TEXT_PROMPT_AGENT

    %% Prompt Enhancement
    PROMPT_ENHANCEMENT_AGENT --> GEMINI_PROMPT_OPTIMIZATION[ðŸ§  Gemini Prompt Optimization]
    GEMINI_PROMPT_OPTIMIZATION --> STYLE_ANALYSIS_AGENT[ðŸŽ¨ Style Analysis Agent]
    STYLE_ANALYSIS_AGENT --> QUALITY_ENHANCEMENT_AGENT[â­ Quality Enhancement Agent]

    QUALITY_ENHANCEMENT_AGENT --> ENHANCED_PROMPT_STORAGE[ðŸ’¾ Enhanced Prompt Storage]

    %% Generation Parameters
    ENHANCED_PROMPT_STORAGE --> PARAMETER_SETUP_AGENT[âš™ï¸ Parameter Setup Agent]
    PARAMETER_SETUP_AGENT --> STYLE_SELECTION_AGENT[ðŸŽ¨ Style Selection Agent]
    PARAMETER_SETUP_AGENT --> DIMENSION_SELECTION_AGENT[ðŸ“ Dimension Selection Agent]
    PARAMETER_SETUP_AGENT --> QUALITY_SELECTION_AGENT[â­ Quality Selection Agent]

    STYLE_SELECTION_AGENT --> ARTISTIC_STYLE_AGENT[ðŸŽ­ Artistic Style Agent]
    STYLE_SELECTION_AGENT --> REALISTIC_STYLE_AGENT[ðŸ“· Realistic Style Agent]
    STYLE_SELECTION_AGENT --> ABSTRACT_STYLE_AGENT[ðŸŽ¨ Abstract Style Agent]

    DIMENSION_SELECTION_AGENT --> STANDARD_SIZE_AGENT[ðŸ“ Standard Size Agent]
    DIMENSION_SELECTION_AGENT --> CUSTOM_SIZE_AGENT[ðŸ“ Custom Size Agent]

    QUALITY_SELECTION_AGENT --> STANDARD_QUALITY_AGENT[â­ Standard Quality Agent]
    QUALITY_SELECTION_AGENT --> HIGH_QUALITY_AGENT[â­â­ High Quality Agent]
    QUALITY_SELECTION_AGENT --> ULTRA_QUALITY_AGENT[â­â­â­ Ultra Quality Agent]

    %% AI Model Selection
    QUALITY_SELECTION_AGENT --> MODEL_SELECTION_AGENT[ðŸ¤– Model Selection Agent]
    MODEL_SELECTION_AGENT --> STABLE_DIFFUSION_AGENT[ðŸŽ¨ Stable Diffusion Agent]
    MODEL_SELECTION_AGENT --> DALL_E_AGENT[ðŸŽ­ DALL-E Agent]
    MODEL_SELECTION_AGENT --> MIDJOURNEY_AGENT[ðŸŒŸ Midjourney Agent]
    MODEL_SELECTION_AGENT --> CUSTOM_MODEL_AGENT[ðŸ”§ Custom Model Agent]

    %% Image Generation
    MODEL_SELECTION_AGENT --> GENERATION_INIT_AGENT[ðŸš€ Generation Init Agent]
    GENERATION_INIT_AGENT --> QUEUE_MANAGEMENT_AGENT[ðŸ“‹ Queue Management Agent]

    QUEUE_MANAGEMENT_AGENT --> QUEUE_STATUS{Queue Status}
    QUEUE_STATUS -->|Available| IMMEDIATE_GENERATION[âš¡ Immediate Generation]
    QUEUE_STATUS -->|Busy| QUEUE_POSITION_AGENT[ðŸ“Š Queue Position Agent]

    IMMEDIATE_GENERATION --> AI_MODEL_PROCESSING[ðŸ§  AI Model Processing]
    QUEUE_POSITION_AGENT --> WAIT_NOTIFICATION_AGENT[â° Wait Notification Agent]
    WAIT_NOTIFICATION_AGENT --> AI_MODEL_PROCESSING

    %% AI Processing Pipeline
    AI_MODEL_PROCESSING --> IMAGE_SYNTHESIS_AGENT[ðŸŽ¨ Image Synthesis Agent]
    IMAGE_SYNTHESIS_AGENT --> DETAIL_REFINEMENT_AGENT[ðŸ” Detail Refinement Agent]
    DETAIL_REFINEMENT_AGENT --> COLOR_CORRECTION_AGENT[ðŸŒˆ Color Correction Agent]
    COLOR_CORRECTION_AGENT --> QUALITY_ENHANCEMENT_PROCESSING[â­ Quality Enhancement Processing]

    QUALITY_ENHANCEMENT_PROCESSING --> FINAL_IMAGE_GENERATION[ðŸŽ¨ Final Image Generation]

    %% Quality Check
    FINAL_IMAGE_GENERATION --> QUALITY_VALIDATION_AGENT[âœ… Quality Validation Agent]
    QUALITY_VALIDATION_AGENT -->|Pass| IMAGE_STORAGE_AGENT[ðŸ’¾ Image Storage Agent]
    QUALITY_VALIDATION_AGENT -->|Fail| REGENERATION_AGENT[ðŸ”„ Regeneration Agent]

    REGENERATION_AGENT --> PARAMETER_ADJUSTMENT_AGENT[âš™ï¸ Parameter Adjustment Agent]
    PARAMETER_ADJUSTMENT_AGENT --> GENERATION_INIT_AGENT

    %% Image Storage & Processing
    IMAGE_STORAGE_AGENT --> METADATA_EXTRACTION_AGENT[ðŸ“Š Metadata Extraction Agent]
    METADATA_EXTRACTION_AGENT --> TAG_GENERATION_AGENT[ðŸ·ï¸ Tag Generation Agent]
    TAG_GENERATION_AGENT --> OPTIMIZATION_AGENT[âš¡ Optimization Agent]

    OPTIMIZATION_AGENT --> FORMAT_CONVERSION_AGENT[ðŸ”„ Format Conversion Agent]
    FORMAT_CONVERSION_AGENT --> CDN_UPLOAD_AGENT[â˜ï¸ CDN Upload Agent]

    %% User Interaction
    CDN_UPLOAD_AGENT --> IMAGE_PRESENTATION_AGENT[ðŸ‘ï¸ Image Presentation Agent]
    IMAGE_PRESENTATION_AGENT --> USER_ACTION{User Action}

    USER_ACTION -->|Download| DOWNLOAD_AGENT[ðŸ“¥ Download Agent]
    USER_ACTION -->|Edit| EDIT_AGENT[âœï¸ Edit Agent]
    USER_ACTION -->|Share| SHARE_AGENT[ðŸ“¤ Share Agent]
    USER_ACTION -->|Regenerate| REGENERATE_AGENT[ðŸ”„ Regenerate Agent]
    USER_ACTION -->|Save to Gallery| GALLERY_SAVE_AGENT[ðŸ–¼ï¸ Gallery Save Agent]

    %% Download Flow
    DOWNLOAD_AGENT --> FORMAT_SELECTION_AGENT[ðŸ“„ Format Selection Agent]
    FORMAT_SELECTION_AGENT --> SIZE_SELECTION_AGENT[ðŸ“ Size Selection Agent]
    SIZE_SELECTION_AGENT --> DOWNLOAD_PROCESSING_AGENT[âš™ï¸ Download Processing Agent]

    DOWNLOAD_PROCESSING_AGENT --> FILE_GENERATION_AGENT[ðŸ“„ File Generation Agent]
    FILE_GENERATION_AGENT --> DOWNLOAD_DELIVERY_AGENT[ðŸ“¥ Download Delivery Agent]

    %% Edit Flow
    EDIT_AGENT --> EDIT_TOOL_SELECTION_AGENT[ðŸ› ï¸ Edit Tool Selection Agent]
    EDIT_TOOL_SELECTION_AGENT --> IMAGE_EDITING_AGENT[ðŸŽ¨ Image Editing Agent]
    IMAGE_EDITING_AGENT --> EDIT_PREVIEW_AGENT[ðŸ‘ï¸ Edit Preview Agent]
    EDIT_PREVIEW_AGENT --> EDIT_APPLY_AGENT[âœ… Edit Apply Agent]

    EDIT_APPLY_AGENT --> IMAGE_STORAGE_AGENT

    %% Share Flow
    SHARE_AGENT --> PLATFORM_SELECTION_AGENT[ðŸŒ Platform Selection Agent]
    PLATFORM_SELECTION_AGENT --> SOCIAL_SHARE_AGENT[ðŸ“± Social Share Agent]
    SOCIAL_SHARE_AGENT --> LINK_GENERATION_AGENT[ðŸ”— Link Generation Agent]

    LINK_GENERATION_AGENT --> SHARE_SUCCESS_AGENT[âœ… Share Success Agent]

    %% Regenerate Flow
    REGENERATE_AGENT --> PARAMETER_MODIFICATION_AGENT[âš™ï¸ Parameter Modification Agent]
    PARAMETER_MODIFICATION_AGENT --> GENERATION_INIT_AGENT

    %% Gallery Save Flow
    GALLERY_SAVE_AGENT --> GALLERY_ORGANIZATION_AGENT[ðŸ“ Gallery Organization Agent]
    GALLERY_ORGANIZATION_AGENT --> GALLERY_STORAGE_AGENT[ðŸ’¾ Gallery Storage Agent]

    %% Analytics & Learning
    DOWNLOAD_DELIVERY_AGENT --> USAGE_ANALYTICS_AGENT[ðŸ“Š Usage Analytics Agent]
    SHARE_SUCCESS_AGENT --> SOCIAL_ANALYTICS_AGENT[ðŸ“ˆ Social Analytics Agent]
    GALLERY_STORAGE_AGENT --> PREFERENCE_LEARNING_AGENT[ðŸ§  Preference Learning Agent]

    USAGE_ANALYTICS_AGENT --> MODEL_IMPROVEMENT_AGENT[ðŸ“ˆ Model Improvement Agent]
    SOCIAL_ANALYTICS_AGENT --> TREND_ANALYSIS_AGENT[ðŸ“Š Trend Analysis Agent]
    PREFERENCE_LEARNING_AGENT --> PERSONALIZATION_AGENT[ðŸŽ¯ Personalization Agent]

    PERSONALIZATION_AGENT --> STYLE_RECOMMENDATION_AGENT[ðŸ’¡ Style Recommendation Agent]
    STYLE_RECOMMENDATION_AGENT --> PARAMETER_SETUP_AGENT

    %% Error Handling
    AI_MODEL_PROCESSING --> ERROR_CHECK_AGENT{Generation Error?}
    ERROR_CHECK_AGENT -->|Yes| ERROR_HANDLING_AGENT[ðŸš¨ Error Handling Agent]
    ERROR_CHECK_AGENT -->|No| FINAL_IMAGE_GENERATION

    ERROR_HANDLING_AGENT --> RETRY_AGENT[ðŸ”„ Retry Agent]
    RETRY_AGENT --> RETRY_SUCCESS{Retry Success?}
    RETRY_SUCCESS -->|Yes| AI_MODEL_PROCESSING
    RETRY_SUCCESS -->|No| FALLBACK_MODEL_AGENT[ðŸ”„ Fallback Model Agent]

    FALLBACK_MODEL_AGENT --> GENERATION_INIT_AGENT

    %% Rate Limiting
    GENERATION_INIT_AGENT --> RATE_LIMIT_CHECK{Within Rate Limit?}
    RATE_LIMIT_CHECK -->|Yes| QUEUE_MANAGEMENT_AGENT
    RATE_LIMIT_CHECK -->|No| RATE_LIMIT_AGENT[â±ï¸ Rate Limit Agent]

    RATE_LIMIT_AGENT --> WAIT_TIME_CALCULATION_AGENT[â° Wait Time Calculation Agent]
    WAIT_TIME_CALCULATION_AGENT --> WAIT_NOTIFICATION_AGENT

    %% End States
    LOGIN_REDIRECT --> END_LOGIN([ðŸ” Login Required])
    UPGRADE_PROMPT --> END_UPGRADE([ðŸ’Ž Upgrade Required])
    DOWNLOAD_DELIVERY_AGENT --> END_DOWNLOAD([ðŸ“¥ Download Complete])
    SHARE_SUCCESS_AGENT --> END_SHARE([ðŸ“¤ Share Complete])
    GALLERY_STORAGE_AGENT --> END_SAVE([ðŸ’¾ Save Complete])
    MODEL_IMPROVEMENT_AGENT --> END_SUCCESS([ðŸŽ‰ Generation Complete])

    %% Styling
    classDef startClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef decisionClass fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef processClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef parallelClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef errorClass fill:#ffebee,stroke:#b71c1c,stroke-width:2px
    classDef endClass fill:#e8eaf6,stroke:#1a237e,stroke-width:2px
    classDef agentClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef aiClass fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef userClass fill:#e1f5fe,stroke:#0277bd,stroke-width:2px

    class START,END_SUCCESS,END_DOWNLOAD,END_SHARE,END_SAVE startClass
    class AUTH_CHECK,SUBSCRIPTION_CHECK,INPUT_METHOD,USER_ACTION,QUALITY_VALIDATION_AGENT,ERROR_CHECK_AGENT,RETRY_SUCCESS,RATE_LIMIT_CHECK decisionClass
    class TEXT_PROMPT_AGENT,VOICE_PROMPT_AGENT,REFERENCE_IMAGE_AGENT,TEMPLATE_AGENT,PROMPT_VALIDATION_AGENT,PROMPT_ENHANCEMENT_AGENT,VOICE_CAPTURE_AGENT,SPEECH_TO_TEXT_AGENT,IMAGE_UPLOAD_AGENT,IMAGE_ANALYSIS_AGENT,PROMPT_GENERATION_AGENT,TEMPLATE_SELECTION_AGENT,TEMPLATE_CUSTOMIZATION_AGENT,GEMINI_PROMPT_OPTIMIZATION,STYLE_ANALYSIS_AGENT,QUALITY_ENHANCEMENT_AGENT,ENHANCED_PROMPT_STORAGE,PARAMETER_SETUP_AGENT,STYLE_SELECTION_AGENT,DIMENSION_SELECTION_AGENT,QUALITY_SELECTION_AGENT,ARTISTIC_STYLE_AGENT,REALISTIC_STYLE_AGENT,ABSTRACT_STYLE_AGENT,STANDARD_SIZE_AGENT,CUSTOM_SIZE_AGENT,STANDARD_QUALITY_AGENT,HIGH_QUALITY_AGENT,ULTRA_QUALITY_AGENT,MODEL_SELECTION_AGENT,STABLE_DIFFUSION_AGENT,DALL_E_AGENT,MIDJOURNEY_AGENT,CUSTOM_MODEL_AGENT,GENERATION_INIT_AGENT,QUEUE_MANAGEMENT_AGENT,IMMEDIATE_GENERATION,QUEUE_POSITION_AGENT,WAIT_NOTIFICATION_AGENT,AI_MODEL_PROCESSING,IMAGE_SYNTHESIS_AGENT,DETAIL_REFINEMENT_AGENT,COLOR_CORRECTION_AGENT,QUALITY_ENHANCEMENT_PROCESSING,FINAL_IMAGE_GENERATION,IMAGE_STORAGE_AGENT,METADATA_EXTRACTION_AGENT,TAG_GENERATION_AGENT,OPTIMIZATION_AGENT,FORMAT_CONVERSION_AGENT,CDN_UPLOAD_AGENT,IMAGE_PRESENTATION_AGENT,DOWNLOAD_AGENT,EDIT_AGENT,SHARE_AGENT,REGENERATE_AGENT,GALLERY_SAVE_AGENT,FORMAT_SELECTION_AGENT,SIZE_SELECTION_AGENT,DOWNLOAD_PROCESSING_AGENT,FILE_GENERATION_AGENT,DOWNLOAD_DELIVERY_AGENT,EDIT_TOOL_SELECTION_AGENT,IMAGE_EDITING_AGENT,EDIT_PREVIEW_AGENT,EDIT_APPLY_AGENT,PLATFORM_SELECTION_AGENT,SOCIAL_SHARE_AGENT,LINK_GENERATION_AGENT,SHARE_SUCCESS_AGENT,PARAMETER_MODIFICATION_AGENT,GALLERY_ORGANIZATION_AGENT,GALLERY_STORAGE_AGENT,USAGE_ANALYTICS_AGENT,SOCIAL_ANALYTICS_AGENT,PREFERENCE_LEARNING_AGENT,MODEL_IMPROVEMENT_AGENT,TREND_ANALYSIS_AGENT,PERSONALIZATION_AGENT,STYLE_RECOMMENDATION_AGENT,ERROR_HANDLING_AGENT,RETRY_AGENT,FALLBACK_MODEL_AGENT,RATE_LIMIT_AGENT,WAIT_TIME_CALCULATION_AGENT processClass
    class GEMINI_PROMPT_OPTIMIZATION,AI_MODEL_PROCESSING aiClass
    class PROMPT_CORRECTION_AGENT,REGENERATION_AGENT,PARAMETER_ADJUSTMENT_AGENT errorClass
    class END_LOGIN,END_UPGRADE endClass
    class USER_ACTION,IMAGE_PRESENTATION_AGENT userClass